<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRK: Comparador de Tarifas 2.0 TD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        drk: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        'cta-red': {
                            500: '#CC0000',
                            600: '#A00000',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Tipografía y fondo general */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }

        /* Estilos del escáner */
        #interactive.viewport { position: relative; width: 100%; height: auto; overflow: hidden; border-radius: 1rem; }
        #interactive.viewport > video { width: 100%; height: 100%; object-fit: cover; }
        .loading-ring { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #0ea5e9; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Animaciones */
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilos específicos para los selectores de modo (base) */
        .mode-selector {
            border: 2px solid;
            transition: all 0.2s ease-in-out;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body class="flex flex-col min-h-screen text-slate-800">

    <!-- Navbar -->
    <div class="w-full bg-drk-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tight">DRK <span class="text-drk-500">Energía</span></h1>
            <span class="text-xs bg-drk-800 px-2 py-1 rounded text-drk-100">Comparador Pro 2.0TD</span>
        </div>
    </div>

    <div id="app" class="w-full max-w-lg mx-auto p-4 md:p-6 flex-grow">
        
        <!-- Vista Inicial -->
        <div id="initial-view" class="fade-in">
            <div class="bg-white p-6 rounded-3xl shadow-xl text-center border-t-4 border-drk-500 relative">
                <div class="absolute top-4 right-4 bg-drk-500 px-2 py-1 rounded-full text-white text-xs font-bold shadow-md">
                    V - <span id="tariff-display-badge">0</span>
                </div>
                <!-- START: COMPARISON MODE SELECTORS -->
                <div class="mb-4 bg-drk-50 p-3 rounded-xl border border-drk-100">
                    <p class="text-sm font-bold text-drk-800 mb-2">MODO DE COMPARACIÓN</p>
                    <div id="comparison-mode-selectors" class="flex flex-wrap justify-center gap-2 text-sm">
                        <!-- Selector 1: DRK Únicamente -->
                        <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer border-drk-300 bg-white text-slate-600 hover:bg-drk-100" 
                                id="mode-drk-only-label">
                            <input type="radio" name="comparison_mode" value="drk_only" id="mode-drk-only" class="hidden">
                            <span class="font-semibold">DRK Únicamente</span>
                        </label>
                        <!-- Selector 2: DRK Prioritario (Default) -->
                        <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer border-drk-500 text-white bg-drk-500 hover:bg-drk-600" 
                                id="mode-drk-prioritized-label">
                            <input type="radio" name="comparison_mode" value="drk_prioritized" id="mode-drk-prioritized" class="hidden" checked>
                            <span class="font-semibold">DRK Prioritario</span>
                        </label>
                        <!-- Selector 3: Mejor en el Mercado -->
                        <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer border-drk-300 bg-white text-slate-600 hover:bg-drk-100" 
                                id="mode-overall-best-label">
                            <input type="radio" name="comparison_mode" value="overall_best" id="mode-overall-best" class="hidden">
                            <span class="font-semibold">Mejor en el Mercado</span>
                        </label>
                    </div>
                </div>
                <!-- END: COMPARISON MODE SELECTORS -->
                <div class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Analizar Factura</h2>
                <p class="text-slate-500 mb-6">Escanea el código QR de la factura.</p>
                <button id="start-scan-btn" class="w-full bg-gradient-to-r from-drk-600 to-drk-800 hover:from-drk-700 hover:to-drk-900 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.125 3h3.75a2 2 0 011.664.89l.812 1.22a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>ESCANEAR QR AHORA</span>
                </button>
                <input type="file" id="image-file-input" accept="image/*" class="hidden">
                <button id="upload-menu-btn" class="w-full bg-drk-50 hover:bg-drk-100 text-drk-800 font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1m-4-5l-1-1m0 0l-1-1m0 0l-1-1M12 12v.01"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span>OPCIONES QR MANUAL</span>
                </button>
                <p id="loading-status" class="text-center text-sm text-slate-400 mt-4 hidden">Cargando tarifas...</p>
            </div>
        </div>

        <!-- Vista Escáner -->
        <div id="scanner-view" class="hidden flex-col h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-slate-700">Escaneando...</h2>
                <button id="stop-scan-btn" class="text-red-500 font-bold text-sm bg-red-50 px-3 py-1 rounded-lg">Cancelar</button>
            </div>
            <div class="relative w-full aspect-[3/4] bg-black rounded-2xl overflow-hidden shadow-2xl mb-4">
                <div id="interactive" class="viewport w-full h-full"></div>
                <!-- Marco de escaneo visual -->
                <div class="absolute inset-0 border-2 border-drk-500 opacity-50 m-8 rounded-lg pointer-events-none"></div>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="w-64 h-1 bg-red-500 opacity-50"></div>
                </div>
            </div>
            <p id="scan-message" class="text-center text-sm text-slate-500 mb-4">Enfoca el código QR de la CNMC.</p>
            <button id="capture-photo-btn" class="w-full bg-white border-2 border-drk-500 text-drk-800 font-bold py-3 rounded-xl shadow-sm flex items-center justify-center gap-2">Capturar Foto Manualmente</button>
        </div>

        <!-- Vista Resultados -->
        <div id="results-view" class="hidden animate-fade-in-up">
            <div class="text-center mb-6">
                <div class="inline-flex items-center gap-2 bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold mb-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Análisis Completado
                </div>
                <h2 class="text-2xl font-black text-slate-800">Resultado del Estudio</h2>
                <p class="text-sm text-slate-500">CUPS: <span id="cups-value" class="font-mono text-slate-700"></span></p>
            </div>

            <!-- Tarjeta Resultado en Pantalla -->
            <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100 mb-8 relative">
                <div class="bg-gradient-to-r from-drk-800 to-drk-600 p-6 text-white text-center relative overflow-hidden">
                    <p class="uppercase tracking-widest text-xs font-semibold text-drk-100 mb-1">LA MEJOR OPCIÓN PARA TI ES</p>
                    <h2 id="best-offer-name" class="text-2xl md:text-3xl font-extrabold leading-tight mb-2">Nombre Tarifa</h2>
                    <p id="best-offer-desc" class="text-drk-100 text-sm opacity-90">Descripción</p>
                </div>
                <div class="p-6">
                    <div class="flex flex-col gap-6">
                        <div class="text-center">
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Tu Ahorro Anual Estimado</p>
                            <p id="savings-estimate" class="text-5xl font-black text-green-500 tracking-tight">- €</p>
                        </div>
                        <div class="w-full grid grid-cols-2 text-center text-sm border-b pb-4 border-slate-100">
                            <div class="border-r border-slate-200 pr-2">
                                <p class="text-slate-400 text-xs font-semibold mb-2 uppercase">TU FACTURA ACTUAL</p>
                                <div class="mb-3">
                                    <p class="text-xl font-bold text-red-400 line-through decoration-red-400/50 decoration-2" id="old-period-cost-display">0,00 €</p>
                                    <p class="text-xs text-slate-500 font-medium" id="old-period-days-label">Total Periodo</p> 
                                </div>
                                <div>
                                    <p class="text-lg font-bold text-red-500 line-through decoration-red-500/50 decoration-2" id="old-annual-cost-display">0,00 €/año</p>
                                </div>
                            </div>
                            <div class="pl-2">
                                <p class="text-drk-800 text-xs font-semibold mb-2 uppercase">TU NUEVO COSTE DRK</p>
                                <div class="mb-3">
                                    <p class="text-2xl font-black text-drk-900" id="new-monthly-cost-display">0,00 €/mes</p>
                                    <p class="text-xs text-drk-800 font-medium">Estimado Mensual</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-black text-drk-900" id="new-annual-cost-display">0,00 €/año</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="grid grid-cols-1 gap-3 mb-8">
                    <button id="send-offer-btn" class="w-full bg-cta-red-500 hover:bg-cta-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-4-4l-4 4m0 0l-4-4m4 4V5"></path></svg>
                    <span>COPIAR COMPARATIVO</span>
                </button>
                    <button onclick="document.getElementById('details-container').classList.toggle('hidden')" class="text-center text-drk-800 font-bold text-sm hover:underline flex items-center justify-center gap-1">
                    Ver desglose detallado del cálculo
                </button>
            </div>

            <div id="details-container" class="hidden space-y-6">
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-drk-500 pl-3">Datos Extraídos</h3>
                <div id="user-consumption-details" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm"></div>
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3">Cálculo Oficial</h3>
                <div id="cost-breakdown" class="bg-white p-0 rounded-xl border border-slate-200 shadow-sm overflow-hidden text-sm"></div>
                <!-- Debug invisible -->
                <div id="comparison-details" class="hidden"></div> 
            </div>

            <div class="mt-8">
                <button onclick="resetApp()" class="w-full bg-white border-2 border-slate-200 hover:border-drk-500 text-slate-600 hover:text-drk-800 font-bold py-4 rounded-xl transition flex items-center justify-center gap-2">
                    Realizar Nueva Comparación
                </button>
            </div>
        </div>
        
        <!-- Modales -->
        <div id="qr-options-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4">Seleccione Opción</h3>
                <button id="modal-upload-file-btn" class="w-full bg-drk-800 hover:bg-drk-900 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-3">Subir Imagen</button>
                <button id="modal-paste-image-btn" class="w-full bg-drk-600 hover:bg-drk-800 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-4">Pegar Imagen (CTRL+V)</button>
                <button onclick="document.getElementById('qr-options-modal').classList.add('hidden'); document.getElementById('qr-options-modal').classList.remove('flex');" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-3 rounded-xl">Cancelar</button>
                <textarea id="paste-catcher" class="opacity-0 w-0 h-0 absolute -z-10" aria-hidden="true"></textarea>
            </div>
        </div>

        <div id="send-offer-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4">Datos del Comercial y Cliente</h3>
                <input type="text" id="comercial-code-input" placeholder="CÓDIGO COMERCIAL (Obligatorio)" class="w-full mb-3 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-drk-500 outline-none text-sm">
                <input type="text" id="client-name-input" placeholder="Nombre Cliente (Opcional)" class="w-full mb-3 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-drk-500 outline-none text-sm">
                <input type="tel" id="client-phone-input" placeholder="Teléfono Cliente (Opcional)" class="w-full mb-3 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-drk-500 outline-none text-sm">
                <input type="email" id="client-email-input" placeholder="Email Cliente (Opcional)" class="w-full mb-4 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-drk-500 outline-none text-sm">
                
                <!-- Botón de Copiar HTML (función original) -->
                <button id="execute-send-offer-btn" class="w-full bg-cta-red-500 hover:bg-cta-red-600 text-white font-bold py-3 rounded-xl shadow-md mb-3">COPIAR COMPARATIVO (HTML)</button>
                
                <button onclick="document.getElementById('send-offer-modal').classList.add('hidden'); document.getElementById('send-offer-modal').classList.remove('flex');" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-3 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <div id="error-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center">
                <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4" id="error-icon"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                <h3 class="text-lg font-bold text-slate-800 mb-2" id="error-title">¡Ups! Algo salió mal</h3>
                <p id="error-message" class="text-slate-600 text-sm mb-6"></p>
                <button onclick="hideErrorModal()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl">Entendido</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // MODIFICADO: Nuevo SHEET_ID proporcionado por el usuario
        const SHEET_ID = '1iJjqNYPNhVhTt5TjDxDt_hB8B-C9Mr07ETHsexv4hWA'; 
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=0`;
        const ANNUAL_DAYS = 365;
        const LOCAL_STORAGE_KEY = 'drk_loaded_tariffs';

        let currentTariffs = [];
        let lastComparisonResult = null;
        let scannerRunning = false;
        let stream = null, video = null, canvas = null, canvasCtx = null, animationFrameId = null;
        let comparisonMode = 'drk_prioritized'; // Default mode (DRK Prioritario)

        const els = {
            initialView: document.getElementById('initial-view'),
            resultsView: document.getElementById('results-view'),
            scannerView: document.getElementById('scanner-view'),
            interactiveViewport: document.getElementById('interactive'),
            startScanBtn: document.getElementById('start-scan-btn'),
            stopScanBtn: document.getElementById('stop-scan-btn'),
            capturePhotoBtn: document.getElementById('capture-photo-btn'),
            loadingStatus: document.getElementById('loading-status'),
            sendOfferBtn: document.getElementById('send-offer-btn'),
            sendOfferModal: document.getElementById('send-offer-modal'),
            comercialCodeInput: document.getElementById('comercial-code-input'),
            clientNameInput: document.getElementById('client-name-input'),
            clientPhoneInput: document.getElementById('client-phone-input'),
            clientEmailInput: document.getElementById('client-email-input'),
            executeSendOfferBtn: document.getElementById('execute-send-offer-btn'),
            tariffDisplayBadge: document.getElementById('tariff-display-badge'),
            uploadMenuBtn: document.getElementById('upload-menu-btn'),
            imageFileInput: document.getElementById('image-file-input'),
            qrOptionsModal: document.getElementById('qr-options-modal'),
            modalPasteImageBtn: document.getElementById('modal-paste-image-btn'), 
            pasteCatcher: document.getElementById('paste-catcher'), 
            bestOfferName: document.getElementById('best-offer-name'),
            bestOfferDesc: document.getElementById('best-offer-desc'),
            savingsEstimate: document.getElementById('savings-estimate'),
            oldAnnualCostDisplay: document.getElementById('old-annual-cost-display'),
            newAnnualCostDisplay: document.getElementById('new-annual-cost-display'),
            oldPeriodCostDisplay: document.getElementById('old-period-cost-display'), 
            oldPeriodDaysLabel: document.getElementById('old-period-days-label'), 
            newMonthlyCostDisplay: document.getElementById('new-monthly-cost-display'), 
            cupsValue: document.getElementById('cups-value'),
            userConsumptionDetails: document.getElementById('user-consumption-details'),
            costBreakdown: document.getElementById('cost-breakdown')
        };

        function updateTariffCount() {
            els.tariffDisplayBadge.textContent = currentTariffs.length;
            if (currentTariffs.length > 0) {
                els.loadingStatus.classList.add('hidden');
                els.startScanBtn.disabled = false;
                els.uploadMenuBtn.disabled = false;
            } else {
                els.loadingStatus.textContent = "Error: No hay tarifas disponibles. Verifique permisos de Google Sheet.";
                els.loadingStatus.classList.remove('hidden');
                els.startScanBtn.disabled = true;
                els.uploadMenuBtn.disabled = true;
            }
        }
        function loadTariffsFromStorage() { try { const stored = localStorage.getItem(LOCAL_STORAGE_KEY); if (stored) return JSON.parse(stored); } catch (e) { console.error("Storage Error", e); } return []; }
        function saveTariffsToStorage(tariffs) { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tariffs)); }
        
        // --- Lógica mejorada para detectar el delimitador (coma vs punto y coma) ---
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) throw new Error("Archivo CSV vacío.");
            if (lines[0].toLowerCase().includes('<html')) throw new Error("Error de acceso (HTML devuelto).");
            
            let rawHeaders = lines[0].trim();
            
            // DYNAMIC DELIMITER DETECTION: Prioritize semicolon if present, as it's common in Spanish CSV exports.
            let delimiter = ',';
            if ((lines[1] && lines[1].includes(';') && !lines[1].includes(',')) || rawHeaders.includes(';')) {
                delimiter = ';';
            }
            
            const headers = rawHeaders.split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));
            const requiredHeaders = ['name', 'description', 'p1_price', 'p2_price', 'p3_price', 'p_potencia_1', 'p_potencia_2'];
            if (!requiredHeaders.every(h => headers.includes(h))) throw new Error(`Faltan cabeceras. (Delimitador usado: "${delimiter}")`);

            const newTariffs = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Use a simple split for now, assuming quoting is standard enough, but rely on dynamic delimiter
                const values = [];
                let current = '';
                let inQuotes = false;

                // Robust parsing to handle potential embedded delimiters and quotes
                for (let k = 0; k < line.length; k++) {
                    const char = line[k];
                    if (char === '"') {
                        // Handle escaped quote inside quotes ("")
                        if (k + 1 < line.length && line[k+1] === '"') {
                            current += '"';
                            k++; 
                        } else {
                             inQuotes = !inQuotes;
                        }
                    }
                    else if (char === delimiter && !inQuotes) {
                        values.push(current); 
                        current = '';
                    }
                    else { 
                        current += char; 
                    }
                }
                values.push(current); 

                if (values.length !== headers.length) continue;
                
                const tariff = { cups_match: ["2.0TD"] };
                let isValidTariff = true;
                for (let j = 0; j < headers.length; j++) {
                    const header = headers[j];
                    const value = values[j].trim().replace(/^"|"$/g, ''); 
                    if (header.includes('price') || header.includes('potencia')) {
                        // Crucial: Replace comma with dot for correct number parsing, as Spanish Sheets use comma as decimal separator
                        const numValue = parseFloat(value.replace(',', '.')); 
                        if (!isNaN(numValue)) { tariff[header] = numValue; } 
                        else { isValidTariff = false; break; }
                    } else { tariff[header] = value; }
                }
                
                tariff.isDrk = tariff.name ? tariff.name.toUpperCase().includes('DRK') : false;

                if (isValidTariff && tariff.p1_price !== undefined) newTariffs.push(tariff);
            }
            return newTariffs;
        }

        async function fetchTariffsFromSheet() {
            els.loadingStatus.textContent = "Cargando tarifas...";
            els.loadingStatus.classList.remove('hidden');

            const fetchAndParse = async (url) => {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const csvText = await response.text();
                const loaded = parseCSV(csvText);
                if (loaded.length === 0) throw new Error("No se encontraron tarifas.");
                return loaded;
            };

            let successful = false;
            const urlsToTry = [
                SHEET_URL, 
                `${SHEET_URL}&t=${Date.now()}` // Cache-busting URL
            ];

            for (let i = 0; i < urlsToTry.length; i++) {
                const url = urlsToTry[i];
                try {
                    if (i > 0) {
                             els.loadingStatus.textContent = "Reintentando carga de tarifas...";
                    }
                    const loaded = await fetchAndParse(url);
                    currentTariffs = loaded;
                    saveTariffsToStorage(currentTariffs);
                    successful = true;
                    break;
                } catch (err) {
                    console.error(`Error fetching (Intento ${i + 1}):`, err.message);
                }
            }
            
            if (!successful) {
                currentTariffs = loadTariffsFromStorage();
                if (currentTariffs.length === 0) {
                     window.showErrorModal("Error crítico: No se pudieron cargar tarifas desde el servidor. Verifique que la hoja de cálculo esté configurada como **pública (Cualquier persona con el enlace puede ver)**.");
                } else {
                     els.loadingStatus.textContent = `Error de red. Usando ${currentTariffs.length} tarifas de la caché.`;
                }
            }
            
            updateTariffCount();
        }

        function dateDiffInDays(d1, d2) {
            // Function to parse dates in DD/MM/YYYY or YYYY-MM-DD or YYYYMMDD format
            const parse = (str) => {
                if (!str || str.length < 8) return null;
                if (str.includes('/')) { const p = str.split('/'); return new Date(p[2], p[1]-1, p[0]); } // DD/MM/YYYY
                if (str.includes('-')) { const p = str.split('-'); return new Date(p[0], p[1]-1, p[2]); } // YYYY-MM-DD
                if (str.length === 8) { const y = str.substring(0,4), m = str.substring(4,6), d = str.substring(6,8); return new Date(y, m-1, d); } // YYYYMMDD (Less likely but safer)
                return null;
            }
            const dt1 = parse(d1), dt2 = parse(d2);
            if(!dt1 || !dt2) return 0;
            // Calculate difference and add 1 day for inclusive period
            return Math.ceil(Math.abs(dt2 - dt1) / (1000 * 60 * 60 * 24)) + 1;
        }

        function handleQRRead(raw) {
            // Stop scanner loop immediately
            stopScanner();

            // Clean raw URL (remove CNMC base URL) and parse parameters
            if (raw.includes('?')) raw = raw.split('?')[1] || raw;
            const p = {};
            raw.split('&').forEach(part => { 
                const [k, v] = part.split('='); 
                // Replace comma with dot for correct float parsing later (standard for QR data)
                if(k) p[k] = decodeURIComponent(v||'').replace(',', '.'); 
            });
            
            const data = {
                cups: p.cups || 'No detectado',
                dias_facturados: dateDiffInDays(p.iniF, p.finF),
                consumo_punta: parseFloat(p.cfP1||0),
                consumo_llano: parseFloat(p.cfP2||0),
                consumo_valle: parseFloat(p.cfP3||0),
                consumo_total: parseFloat(p.cfP1||0)+parseFloat(p.cfP2||0)+parseFloat(p.cfP3||0),
                potencia_p1_kw: parseFloat(p.pP1||0),
                potencia_p2_kw: parseFloat(p.pP2||0),
                importe_total: parseFloat(p.imp||0), 
                fechas: `${p.iniF || '?'} - ${p.finF || '?'}`
            };

            if (data.dias_facturados === 0 || data.importe_total <= 0) {
                window.showErrorModal("QR incompleto o inválido. No se pudieron extraer datos de consumo o importes.");
                window.resetApp();
                return;
            }
            
            // Only compare offers if tariffs are loaded
            if (currentTariffs.length > 0) {
                compareOffers(data);
            } else {
                 window.showErrorModal("Las tarifas no se han cargado correctamente. Intente de nuevo más tarde.");
                 window.resetApp();
            }
        }
        
        // --- NEW HELPER FUNCTION TO CALCULATE COST FOR A SINGLE TARIFF ---
        function calculateTariffCost(tariff, data) {
            const IVA_RATE = 0.21; // 21% IVA
            const IE_RATE = 0.05113; // Impuesto de Electricidad (actual)
            const ANNUAL_DAYS_CONST = 365;

            // 1. Costes de Potencia (Periodo)
            // Nota: Los precios de potencia de la hoja están en €/kW/año. Se dividen por 365 para obtener €/kW/día.
            const priceP1Day = tariff.p_potencia_1 / ANNUAL_DAYS_CONST;
            const priceP2Day = tariff.p_potencia_2 / ANNUAL_DAYS_CONST;
            
            const costP1 = data.potencia_p1_kw * data.dias_facturados * priceP1Day;
            const costP2 = data.potencia_p2_kw * data.dias_facturados * priceP2Day;
            const subPower = costP1 + costP2;

            // 2. Costes de Energía (Consumo)
            const costE1 = data.consumo_punta * tariff.p1_price;
            const costE2 = data.consumo_llano * tariff.p2_price;
            const costE3 = data.consumo_valle * tariff.p3_price;
            const subEnergy = costE1 + costE2 + costE3;

            // 3. Impuestos y total
            const subBase = subPower + subEnergy;
            const costIE = subBase * IE_RATE; // Impuesto Eléctrico (sobre la base de P+E)
            const baseImp = subBase + costIE; // Base imponible = Base + IE
            const costIVA = baseImp * IVA_RATE; // IVA (sobre la base imponible)
            
            const totalPeriod = baseImp + costIVA; // Coste total estimado para el periodo
            
            // 4. Proyección Anual
            const factorAnual = ANNUAL_DAYS_CONST / data.dias_facturados;
            const totalAnnual = totalPeriod * factorAnual; 
            const originalBillAnnual = data.importe_total * factorAnual;

            return {
                ...data, costP1, costP2, subPower, costE1, costE2, costE3, subEnergy,
                subBase, costIE, baseImp, costIVA, totalPeriod, totalAnnual,
                priceP1Day, priceP2Day, IE_RATE,
                originalBillAnnual, 
                savings: originalBillAnnual - totalAnnual,
                offer: tariff
            };
        }


        // --- MODIFIED compareOffers FUNCTION (IMPLEMENTS THE 3 MODES) ---
        function compareOffers(data) {
            
            // 1. Calculate costs for all available tariffs
            const allComparisons = currentTariffs.map(t => calculateTariffCost(t, data));

            let bestOverallComparison = null;
            let bestDrkComparison = null;

            // Find the best overall and best DRK option
            allComparisons.forEach(c => {
                // Track Overall Best (Lowest Annual Cost)
                if (!bestOverallComparison || c.totalAnnual < bestOverallComparison.totalAnnual) {
                    bestOverallComparison = c;
                }
                // Track Best DRK (Lowest Annual Cost within DRK tariffs)
                if (c.offer.isDrk) {
                    if (!bestDrkComparison || c.totalAnnual < bestDrkComparison.totalAnnual) {
                        bestDrkComparison = c;
                    }
                }
            });

            if (!bestOverallComparison) {
                return window.showErrorModal("No se encontraron tarifas válidas para la comparación.");
            }

            let finalComparisonResult = null;
            
            // --- Logic based on comparisonMode ---
            if (comparisonMode === 'drk_only') {
                // Mode 1: DRK Only - Choose the best DRK option
                finalComparisonResult = bestDrkComparison;
            } else if (comparisonMode === 'drk_prioritized') {
                // Mode 2: DRK Prioritized - If best DRK is better than current, choose it. If not, fall back to overall best.
                // We use the best DRK found regardless of savings being positive, but we check if *any* offer beats the original.
                // Let's stick to the original logic: If DRK saves money, use it. Else, use the absolute lowest cost (which might be the original bill).
                if (bestDrkComparison && bestDrkComparison.savings > 0) {
                     finalComparisonResult = bestDrkComparison;
                } else {
                    // Check if the overall best is actually the current bill (savings <= 0)
                    if (bestOverallComparison.savings <= 0) {
                        // If current bill is the best option found (savings is 0 or negative for all), simulate a "No-Switch" comparison result.
                        // We use the bestOverallComparison object but mark it for UI rendering as "Current is Best".
                        finalComparisonResult = bestOverallComparison; 
                    } else {
                        // If the overall best is positive, use it.
                        finalComparisonResult = bestOverallComparison;
                    }
                }
            } else if (comparisonMode === 'overall_best') {
                // Mode 3: Overall Best - Choose the absolute best option found (lowest totalAnnual)
                finalComparisonResult = bestOverallComparison;
            }
            
            // Fallback for cases where a specific mode (e.g., drk_only but no drk tariffs) resulted in null
            if (!finalComparisonResult) {
                finalComparisonResult = bestOverallComparison;
            }

            // --- Final Selection and Negative Savings Handling (Universal) ---
            // If the BEST selected result (by the mode) does NOT save money compared to the original bill, 
            // the UI should show the original bill data as the "new" best price, along with 0.00€ saving, and the "Current is Best" text.
            if (finalComparisonResult.savings <= 0) {
                // Negative/Zero Savings Scenario: uses the best available data, but flags it for UI rendering.
                // NOTE: If savings are negative, we calculate the savings relative to the best possible market option (which is the current bill).
                const zeroSavingsResult = { ...finalComparisonResult, isNegativeSavings: true, savings: 0.00, totalAnnual: finalComparisonResult.originalBillAnnual };
                lastComparisonResult = zeroSavingsResult;
            } else {
                lastComparisonResult = { ...finalComparisonResult, isNegativeSavings: false };
            }

            renderResultsUI(lastComparisonResult.offer, lastComparisonResult);
            showView('results-view');
        }

        // --- MODIFIED renderResultsUI FUNCTION (IMPLEMENTS NEGATIVE SAVINGS TEXT) ---
        function renderResultsUI(offer, bd) {
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n);
            const numPrice = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 8, maximumFractionDigits: 8 }).format(n);

            els.cupsValue.textContent = bd.cups;
            
            // 1. Reset strikethrough/color states (important for re-rendering)
            const oldCostElements = document.querySelectorAll('#results-view .grid-cols-2 > div:first-child p');
            oldCostElements.forEach(p => {
                p.classList.remove('text-green-500', 'text-red-500', 'line-through', 'decoration-red-400/50', 'decoration-red-500/50', 'decoration-2', 'font-bold', 'text-red-400', 'text-red-500', 'text-xl', 'text-lg');
            });
            // Re-apply base styles for consistency
            oldCostElements[0].classList.add('text-xl'); // old-period-cost-display
            oldCostElements[2].classList.add('text-lg'); // old-annual-cost-display

            if (bd.isNegativeSavings) {
                // A. Scenario: No mejor opción/Ahorro 0.00
                els.bestOfferName.textContent = "¡Estás en la Mejor Opción!";
                els.bestOfferDesc.textContent = "Tu tarifa actual es la más competitiva del mercado.";
                
                // Savings Display
                els.savingsEstimate.textContent = "0,00 €";
                els.savingsEstimate.className = `text-5xl font-black text-drk-800 tracking-tight`;
                
                // Current Bill Display (Green/No Strikethrough)
                els.oldPeriodCostDisplay.textContent = eur(bd.importe_total);
                els.oldAnnualCostDisplay.textContent = eur(bd.originalBillAnnual) + "/año";
                els.oldPeriodCostDisplay.classList.add('text-green-500', 'font-bold');
                els.oldAnnualCostDisplay.classList.add('text-green-500', 'font-bold');
                
                // New Cost Display should reflect original cost (as there's no better offer)
                els.newMonthlyCostDisplay.textContent = eur(bd.originalBillAnnual / 12) + "/mes";
                els.newAnnualCostDisplay.textContent = eur(bd.originalBillAnnual) + "/año";
                
                // Use a generic placeholder offer name for the breakdown if the best one was not DRK
                // This is a design choice: when no savings, we show the current best price is the current bill.
                offer = { name: "Tu Tarifa Actual", p1_price: 0, p2_price: 0, p3_price: 0, description: "La tarifa que actualmente disfrutas." };
                
            } else {
                // B. Scenario: Ahorro positivo
                els.bestOfferName.textContent = offer.name;
                els.bestOfferDesc.textContent = offer.description;
                els.savingsEstimate.textContent = eur(bd.savings);
                els.savingsEstimate.className = `text-5xl font-black text-green-500 tracking-tight`; // Ahorro Positivo en verde
                
                // Current Bill Display (Red/Strikethrough)
                els.oldPeriodCostDisplay.textContent = eur(bd.importe_total);
                els.oldAnnualCostDisplay.textContent = eur(bd.originalBillAnnual) + "/año";
                els.oldPeriodCostDisplay.classList.add('line-through', 'text-red-400', 'decoration-red-400/50', 'decoration-2', 'font-bold');
                els.oldAnnualCostDisplay.classList.add('line-through', 'text-red-500', 'decoration-red-500/50', 'decoration-2', 'font-bold');

                // New cost displays (The calculated offer cost)
                els.newMonthlyCostDisplay.textContent = eur(bd.totalAnnual / 12) + "/mes";
                els.newAnnualCostDisplay.textContent = eur(bd.totalAnnual) + "/año";
            }
            
            // Standard data display (applies to both cases)
            els.oldPeriodDaysLabel.textContent = `Total Periodo (${bd.dias_facturados} días)`;

            // Details breakdown content is dynamically updated based on the chosen offer
            els.userConsumptionDetails.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div><p class="text-xs text-slate-500">Periodo</p><p class="font-bold text-slate-700">${bd.dias_facturados} días</p></div>
                    <div><p class="text-xs text-slate-500">Fechas</p><p class="font-bold text-slate-700">${bd.fechas}</p></div>
                    <div class="col-span-2 border-t pt-2 mt-2">
                        <div class="flex justify-between text-xs mb-1"><span>E1 (Punta)</span><span class="font-mono">${num(bd.consumo_punta,0)} kWh</span></div>
                        <div class="flex justify-between text-xs mb-1"><span>E2 (Llano)</span><span class="font-mono">${num(bd.consumo_llano,0)} kWh</span></div>
                        <div class="flex justify-between text-xs mb-1"><span>E3 (Valle)</span><span class="font-mono">${num(bd.consumo_valle,0)} kWh</span></div>
                        <div class="flex justify-between font-bold text-drk-800 mt-1"><span>Consumo Total</span><span>${num(bd.consumo_total,0)} kWh</span></div>
                    </div>
                </div>
            `;

            // Note: The cost breakdown only makes sense to show for the *winning* offer, not the user's current bill, 
            // since we don't know the current bill's actual price components.
            els.costBreakdown.innerHTML = `
                <div class="bg-white p-6 font-mono text-xs md:text-sm text-slate-600 leading-relaxed">
                    <div class="text-center border-b-2 border-dashed border-slate-300 pb-4 mb-4">
                        <h4 class="font-bold text-lg text-slate-800 uppercase">${offer.name}</h4>
                        <p>Simulación ${bd.dias_facturados} días</p>
                    </div>
                    <div class="mb-4">
                        <p class="font-bold text-slate-800 mb-1">POTENCIA (€/kW Día)</p>
                        <div class="flex justify-between"><span>P1 (${num(bd.potencia_p1_kw,2)} kW x ${numPrice(bd.priceP1Day)})</span><span>${num(bd.costP1,2)} €</span></div>
                        <div class="flex justify-between"><span>P2 (${num(bd.potencia_p2_kw,2)} kW x ${numPrice(bd.priceP2Day)})</span><span>${num(bd.costP2,2)} €</span></div>
                    </div>
                    <div class="mb-4">
                        <p class="font-bold text-slate-800 mb-1">ENERGÍA (€/kWh)</p>
                        <div class="flex justify-between"><span>E1 (${num(bd.consumo_punta,0)} kWh x ${numPrice(offer.p1_price)})</span><span>${num(bd.costE1,2)} €</span></div>
                        <div class="flex justify-between"><span>E2 (${num(bd.consumo_llano,0)} kWh x ${numPrice(offer.p2_price)})</span><span>${num(bd.costE2,2)} €</span></div>
                        <div class="flex justify-between"><span>E3 (${num(bd.consumo_valle,0)} kWh x ${numPrice(offer.p3_price)})</span><span>${num(bd.costE3,2)} €</span></div>
                    </div>
                    <div class="border-t border-slate-200 pt-2 mb-2">
                        <div class="flex justify-between font-bold text-slate-800"><span>SUBTOTAL</span><span>${num(bd.subBase,2)} €</span></div>
                        <div class="flex justify-between"><span>Imp. Eléc.</span><span>${num(bd.costIE,2)} €</span></div>
                        <div class="flex justify-between font-bold"><span>BASE IMPONIBLE</span><span>${num(bd.baseImp,2)} €</span></div>
                        <div class="flex justify-between"><span>IVA (21%)</span><span>${num(bd.costIVA,2)} €</span></div>
                    </div>
                    <div class="bg-drk-900 text-white p-3 rounded-lg flex justify-between items-center text-md font-bold mb-1"><span>TOTAL PERIODO (${bd.dias_facturados} DÍAS)</span><span>${eur(bd.totalPeriod)}</span></div>
                    <div class="bg-drk-800 text-drk-50 p-3 rounded-lg flex justify-between items-center text-md font-bold"><span>TOTAL AÑO (PROYECTADO)</span><span>${eur(bd.totalAnnual)}</span></div>
                </div>
            `;
        }

        // --- FUNCIÓN RESTAURADA PARA COPIAR EL HTML ---
        async function handleCopyOffer() {
            if (!lastComparisonResult) return window.showErrorModal("Primero realice una comparación.");
            
            const commercialCode = els.comercialCodeInput.value.trim();
            if (!commercialCode) return window.showErrorModal("Indique el Código Comercial.");

            try {
                // 1. Generar el HTML (que incluye el mailto)
                const htmlContent = generateStyledHtmlOffer(commercialCode);
                
                // 2. Crear un elemento temporal para la copia HTML enriquecida
                const tempElement = document.createElement('div');
                tempElement.contentEditable = true;
                // El contenido generado por generateStyledHtmlOffer es un TABLE HTML completo
                tempElement.innerHTML = htmlContent;
                tempElement.style.position = 'fixed';
                tempElement.style.left = '-9999px';
                document.body.appendChild(tempElement);
                
                const range = document.createRange();
                range.selectNodeContents(tempElement);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                let success = document.execCommand('copy');
                document.body.removeChild(tempElement);

                if (success) {
                    window.showMessageModal("✅ ¡Oferta copiada con éxito! Ahora puede pegar (Ctrl+V o Cmd+V) el diseño visual en su correo de escritorio.");
                    els.sendOfferModal.classList.add('hidden');
                    els.sendOfferModal.classList.remove('flex');
                } else {
                    // Fallback para dispositivos que no soportan copia HTML enriquecida
                    window.showErrorModal("No se pudo copiar el diseño visual. Intente desde un PC o utilice la opción de compartir si existe en su dispositivo.");
                }
            } catch (e) {
                console.error("Error al copiar al portapapeles:", e);
                window.showErrorModal(`Error de Portapapeles: ${e.message}`);
            }
        }
        
        // --- FUNCIÓN GENERATESTYLEDHTMLOFFER (Genera el contenido HTML/Mailto para el botón de copia) ---
        function generateStyledHtmlOffer(commercialCode) {
            const bd = lastComparisonResult;
            const offer = bd.offer;
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n);
            
            // Colores DRK
            const BLUE_DARK = '#0c4a6e'; 
            const BLUE_MED = '#075985';
            const BLUE_CTA = '#0284c7';
            const RED_CTA = '#CC0000'; // ROJO CTA
            const BG_LIGHT = '#f0f9ff';
            const GREEN_SAVE = '#16a34a'; // Verde para ahorro positivo
            const GRAY_TEXT = '#555555';

            // Capturar datos del modal o usar placeholders
            const clientName = els.clientNameInput.value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = els.clientPhoneInput.value.trim() || '[TELÉFONO CLIENTE]';
            const clientEmail = els.clientEmailInput.value.trim() || '[EMAIL CLIENTE]';

            // Estilos CSS Inline CLÁSICOS (más compatibles con todos los clientes de email)
            const tableMain = `width: 600px; max-width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; border: 1px solid #dddddd; margin: 0 auto; background: white;`;
            const headerCell = `background-color: ${BLUE_DARK}; color: white; padding: 15px; text-align: center; font-family: Arial, sans-serif;`;
            const sectionTitle = `background-color: ${BLUE_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px; margin-top: 10px; font-family: Arial, sans-serif;`;
            const rowLabel = `padding: 8px; border-bottom: 1px solid #eeeeee; font-size: 13px; color: ${GRAY_TEXT}; font-family: Arial, sans-serif;`;
            const rowValue = `padding: 8px; border-bottom: 1px solid #eeeeee; font-size: 13px; font-weight: bold; color: #333333; text-align: right; font-family: Arial, sans-serif;`;
            const savingsBox = `background-color: ${BLUE_CTA}; color: white; font-size: 20px; font-weight: bold; padding: 15px; text-align: center; border-radius: 8px; margin: 15px 0; font-family: Arial, sans-serif;`;
            const footerStyle = `background-color: ${BLUE_MED}; height: 5px; margin-top: 10px; border-radius: 0 0 8px 8px;`;

            // Estilo para el ANCHOR dentro de la tabla del botón (para clientes modernos)
            const btnAnchorStyle = `color: white; text-decoration: none; font-weight: bold; font-size: 16px; display: block; padding: 12px 24px; font-family: Arial, sans-serif;`;
            
            // --- CUERPO DEL EMAIL (Texto plano: para el mailto:) ---
            const LB = '\r\n';
            const monthlyEstimate = bd.isNegativeSavings ? eur(bd.originalBillAnnual / 12) : eur(bd.totalAnnual / 12);
            const totalConsumption = num(bd.consumo_total, 0) + ' kWh';
            const annualSavings = bd.isNegativeSavings ? '0,00 €' : eur(bd.savings);
            
            // Note: The prices below are the calculated winning offer prices, even if we are in the "no savings" scenario
            const p1PricePerDay = numPriceFormula(bd.priceP1Day);
            const p2PricePerDay = numPriceFormula(bd.priceP2Day);
            const e1Price = numPriceFormula(offer.p1_price);
            const e2Price = numPriceFormula(offer.p2_price);
            const e3Price = numPriceFormula(offer.p3_price);

            const emailBody = `Hola DRK, confirmo la aceptación de la oferta con CUPS: ${bd.cups}.${LB}${LB}` +
                                `--- DATOS DE LA OFERTA ---${LB}${LB}` +
                                `Comercializadora y Tarifa: DRK ENERGÍA - ${offer.name}${LB}` +
                                `Zona Geográfica: PENINSULA${LB}` +
                                `Ahorro Anual Estimado: ${annualSavings}${LB}` +
                                `Total Mensual Estimado: ${monthlyEstimate}${LB}` +
                                `Consumo Total Facturado: ${totalConsumption}${LB}${LB}` +
                                `--- DETALLE DE PRECIOS (€) ---${LB}` +
                                `P1 (Potencia - €/kW/día): ${p1PricePerDay}${LB}` +
                                `P2 (Potencia - €/kW/día): ${p2PricePerDay}${LB}` +
                                `E1 (Energía - €/kWh): ${e1Price}${LB}` +
                                `E2 (Energía - €/kWh): ${e2Price}${LB}` +
                                `E3 (Energía - €/kWh): ${e3Price}${LB}` +
                                `------------------------------${LB}${LB}` +
                                `Por favor, utilicen los siguientes datos para tramitar mi cambio:${LB}` +
                                `--------------------------------------------------------${LB}` +
                                `DATOS DEL CLIENTE (A RELLENAR):${LB}` +
                                `--------------------------------------------------------${LB}` +
                                `Nombre completo: ${clientName}${LB}` +
                                `Teléfono de contacto: ${clientPhone}${LB}` +
                                `Email de contacto: ${clientEmail}${LB}${LB}` +
                                `--------------------------------------------------------${LB}` +
                                `INFORMACIÓN ADICIONAL (Opcional):${LB}` +
                                `--------------------------------------------------------${LB}` +
                                `[AGREGUE CUALQUIER COMENTARIO EXTRA AQUÍ]${LB}${LB}` +
                                `--- DOCUMENTACIÓN REQUERIDA ---${LB}` +
                                `Para formalizar el contrato, por favor, responde a este email adjuntando:${LB}` +
                                `1. Foto del DNI/CIF (anverso y reverso).${LB}` +
                                `2. Última factura (mínimo 3 meses de antigüedad).${LB}` +
                                `3. Email de contacto para validación.${LB}` +
                                `4. Teléfono de contacto.${LB}` +
                                `5. Número de cuenta bancaria (IBAN).${LB}${LB}` +
                                `Adjunto la documentación requerida.`;


            const subject = `ACEPTACIÓN OFERTA - ${bd.cups}`; 
            const formalizationLink = `mailto:f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            
            // --- VML Button Generation (Hybrid approach for Outlook reliability) ---
            const VML_BUTTON = (link, text) => `
                <!--[if mso]>
                  <v:roundrect xmlns:v="urn:schemas-microsoft-com:vml" xmlns:w="urn:schemas-microsoft-com:office:word" href="${link}" style="height:48px;v-text-anchor:middle;width:560px;" arcsize="10%" strokecolor="${RED_CTA}" fillcolor="${RED_CTA}">
                    <w:anchorlock/>
                    <center style="color:#ffffff;font-family:Arial, sans-serif;font-size:16px;font-weight:bold;">${text}</center>
                  </v:roundrect>
                <![endif]-->
                <!--[if !mso]><!-->
                <table cellspacing="0" cellpadding="0" border="0" style="width: 100%; border-collapse: collapse;" role="presentation">
                    <tr>
                        <td align="center" style="background-color: ${RED_CTA}; border-radius: 6px; padding: 0; margin: 0; ">
                            <a href="${link}" target="_blank" style="${btnAnchorStyle}">
                                <span style="display: block; padding: 12px 24px;">${text}</span>
                            </a>
                        </td>
                    </tr>
                </table>
                <!--<![endif]-->
            `;

            const CTA_SECTION = bd.isNegativeSavings ? VML_BUTTON(formalizationLink, 'CONTACTAR COMERCIAL') : VML_BUTTON(formalizationLink, 'QUIERO LA OFERTA');

            // --- CUERPO DE LA TABLA PRINCIPAL (PARA EL HTML COMPLETO) ---
            const mainTableContent = bd.isNegativeSavings ? `
                <table width="600" cellpadding="0" cellspacing="0" border="0" style="${tableMain} mso-table-lspace: 0pt !important; mso-table-rspace: 0pt !important; border-radius: 8px;" role="presentation">
                    <!-- HEADER (DRK Theme) -->
                    <tr><td colspan="2" style="${headerCell} border-radius: 8px 8px 0 0;">
                        <h1 style="margin:0; font-size: 24px;">ESTUDIO DE AHORRO</h1>
                        <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">COMPARATIVA PROFESIONAL - DRK ENERGÍA</p>
                    </td></tr>
                    
                    <!-- DATOS CLIENTE -->
                    <tr><td colspan="2" style="padding: 15px;">
                        <p style="margin: 0; font-size: 13px; font-family: Arial, sans-serif;"><strong>CLIENTE:</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px; font-family: Arial, sans-serif;"><strong>CUPS:</strong> ${bd.cups}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px; font-family: Arial, sans-serif;"><strong>COMERCIAL:</strong> ${commercialCode || 'N/A'}</p>
                    </td></tr>

                    <!-- RESULTADO POSITIVO DE NO AHORRO -->
                    <tr><td colspan="2" style="background-color: #e0f2fe; padding: 25px 20px; text-align: center; border-top: 2px solid ${BLUE_MED}; border-bottom: 2px solid ${BLUE_MED};">
                        <div style="font-size: 60px; color: ${BLUE_CTA}; margin-bottom: 10px;">
                            <span style="display: inline-block;">✅</span>
                        </div>
                        <p style="margin: 0; color: ${BLUE_DARK}; font-size: 22px; font-weight: bold; font-family: Arial, sans-serif;">¡Excelente Noticia!</p>
                        <h2 style="margin: 5px 0 10px 0; color: ${BLUE_DARK}; font-size: 18px; font-weight: normal; font-family: Arial, sans-serif;">TU TARIFA ACTUAL ES LA MÁS COMPETITIVA DEL MERCADO</h2>
                        <p style="margin: 0; font-size: 14px; color: ${GRAY_TEXT}; font-family: Arial, sans-serif;">En este momento, no existe una oferta que mejore tu coste actual. Seguiremos estudiando el mercado por ti.</p>
                    </td></tr>

                    <!-- ESTADO ACTUAL (Destacado) -->
                    <tr><td colspan="2" style="padding: 20px; text-align: center;">
                        <p style="font-size: 14px; font-weight: bold; color: ${BLUE_DARK}; margin-bottom: 5px; font-family: Arial, sans-serif;">COSTE ANUAL ESTIMADO (ACTUAL):</p>
                        <span style="font-size: 32px; font-weight: bold; color: ${GREEN_SAVE}; display: block; font-family: Arial, sans-serif;">${eur(bd.originalBillAnnual)}</span>
                        <p style="font-size: 12px; color: #888888; font-family: Arial, sans-serif;">/ AÑO</p>
                    </td></tr>

                    <!-- CTA BOTÓN VML/HTML (Contactar Comercial) -->
                    <tr><td colspan="2" align="center" style="text-align: center; padding: 0 20px 20px 20px;">
                        ${CTA_SECTION}
                        <p style="font-size: 10px; color: #999; margin-top: 10px; font-family: Arial, sans-serif;">[Colaborador: ${commercialCode}] | Este resumen es una simulación basada en su última factura.</p>
                    </td></tr>

                    <!-- FOOTER -->
                    <tr><td colspan="2" style="padding: 0; height: 10px;"><div style="${footerStyle} border-radius: 0 0 8px 8px;"></div></td></tr>
                </table>
            ` : `
                <table width="600" cellpadding="0" cellspacing="0" border="0" style="${tableMain} mso-table-lspace: 0pt !important; mso-table-rspace: 0pt !important; border-radius: 8px;" role="presentation">
                    <!-- HEADER -->
                    <tr><td colspan="2" style="${headerCell} border-radius: 8px 8px 0 0;">
                        <h1 style="margin:0; font-size: 24px; font-family: Arial, sans-serif;">ESTUDIO DE AHORRO</h1>
                        <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9; font-family: Arial, sans-serif;">COMPARATIVA PROFESIONAL - DRK ENERGÍA</p>
                    </td></tr>
                    
                    <!-- DATOS CLIENTE -->
                    <tr><td colspan="2" style="padding: 15px;">
                        <p style="margin: 0; font-size: 13px; font-family: Arial, sans-serif;"><strong>CLIENTE:</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px; font-family: Arial, sans-serif;"><strong>CUPS:</strong> ${bd.cups}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px; font-family: Arial, sans-serif;"><strong>COMERCIAL:</strong> ${commercialCode || 'N/A'}</p>
                    </td></tr>

                    <!-- TARIFA GANADORA -->
                    <tr><td colspan="2" style="background-color: ${BG_LIGHT}; padding: 15px; text-align: center; border-top: 2px solid ${BLUE_MED}; border-bottom: 2px solid ${BLUE_MED}; font-family: Arial, sans-serif;">
                        <p style="margin: 0; color: ${BLUE_MED}; font-size: 12px; font-weight: bold; letter-spacing: 1px; font-family: Arial, sans-serif;">LA MEJOR OPCIÓN PARA TI ES</p>
                        <h2 style="margin: 5px 0 0 0; color: ${BLUE_DARK}; font-size: 22px; font-family: Arial, sans-serif;">${offer.name}</h2>
                    </td></tr>

                    <!-- 1. AHORRO (RESUMEN POTENTE INICIAL) -->
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <div style="text-align: center; margin: 25px 0 10px 0; font-family: Arial, sans-serif;">
                            <p style="margin: 0; font-size: 16px; color: ${GRAY_TEXT}; font-weight: bold; font-family: Arial, sans-serif;">TU AHORRO ANUAL ESTIMADO ES:</p>
                        </div>
                        <div style="${savingsBox}">
                            <span style="font-size: 38px; font-family: Arial, sans-serif;">${eur(bd.savings)}</span>
                            <p style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold; font-family: Arial, sans-serif;">¡CONSIGUE TU AHORRO ANUAL!</p>
                        </div>
                    </td></tr>

                    <!-- 2. COMPARATIVA (Factura Actual vs. Nuevo Coste DRK) -->
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="margin-bottom: 20px; border-collapse: collapse;" role="presentation">
                            <tr>
                                <td width="50%" style="padding: 15px; background-color: #f9fafb; border: 1px solid #dddddd; text-align: center; vertical-align: top; font-family: Arial, sans-serif;">
                                    <div style="font-size: 11px; font-weight: bold; color: #888888; text-transform: uppercase;">TU FACTURA ACTUAL</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #ef4444; margin: 5px 0; text-decoration: line-through;">${eur(bd.originalBillAnnual)}</div>
                                    <div style="font-size: 11px; color: #666666;">/ AÑO</div>
                                </td>
                                <td width="50%" style="padding: 15px; background-color: ${BG_LIGHT}; border: 1px solid ${BLUE_MED}; text-align: center; vertical-align: top; font-family: Arial, sans-serif;">
                                    <div style="font-size: 11px; font-weight: bold; color: ${BLUE_MED}; text-transform: uppercase;">TU NUEVO COSTE DRK</div>
                                    <div style="font-size: 24px; font-weight: bold; color: ${BLUE_DARK}; margin: 5px 0;">${eur(bd.totalAnnual)}</div>
                                    <div style="font-size: 11px; color: ${BLUE_MED};">/ AÑO</div>
                                    <div style="font-size: 13px; font-weight: bold; color: ${BLUE_DARK}; margin-top: 5px;">${eur(bd.totalAnnual/12)} / MES</div>
                                </td>
                            </tr>
                        </table>
                    </td></tr>
                    
                    <!-- 3. TABLA DE RESUMEN DE PRECIOS -->
                    <tr><td colspan="2" style="font-family: Arial, sans-serif;"><div style="${sectionTitle}">RESUMEN DE PRECIOS DE LA OFERTA ÚNICA</div></td></tr>
                    <tr><td colspan="2" style="padding: 0; font-family: Arial, sans-serif;">
                        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="font-family: Arial, sans-serif; font-size: 12px; border-collapse: collapse;" role="presentation">
                            <tr style="background-color: #f5f5f5;">
                                <th style="padding: 5px 8px; text-align: left; color: ${BLUE_DARK}; font-family: Arial, sans-serif;">CONCEPTO</th>
                                <th style="padding: 5px 8px; text-align: right; color: ${BLUE_DARK}; font-family: Arial, sans-serif;">DRK ENERGÍA</th>
                            </tr>
                            <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eeeeee; font-family: Arial, sans-serif;">Potencia P1 (€/kW/día)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eeeeee; text-align: right; font-weight: bold; font-family: monospace;">${numPriceFormula(bd.priceP1Day)}</td></tr>
                            <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eeeeee; font-family: Arial, sans-serif;">Potencia P2 (€/kW/día)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eeeeee; text-align: right; font-weight: bold; font-family: monospace;">${numPriceFormula(bd.priceP2Day)}</td></tr>
                            <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eeeeee; font-family: Arial, sans-serif;">Energía E1 (€/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eeeeee; text-align: right; font-weight: bold; font-family: monospace;">${numPriceFormula(offer.p1_price)}</td></tr>
                            <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eeeeee; font-family: Arial, sans-serif;">Energía E2 (€/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eeeeee; text-align: right; font-weight: bold; font-family: monospace;">${numPriceFormula(offer.p2_price)}</td></tr>
                            <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eeeeee; font-family: Arial, sans-serif;">Energía E3 (€/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eeeeee; text-align: right; font-weight: bold; font-family: monospace;">${numPriceFormula(offer.p3_price)}</td></tr>
                            <tr style="background-color: ${BG_LIGHT}; font-weight: bold;"><td style="padding: 8px; color: ${BLUE_DARK}; font-family: Arial, sans-serif;">AHORRO ANUAL</td><td style="padding: 8px; text-align: right; font-size: 14px; color: ${BLUE_CTA}; font-family: Arial, sans-serif;">${eur(bd.savings)}</td></tr>
                            <!-- ESPACIO SOLICITADO -->
                            <tr style="background-color: white; height: 10px;"><td colspan="2"></td></tr>
                        </table>
                    </td></tr>
                    
                    <!-- 4. DESGLOSE DETALLADO -->
                    <tr><td colspan="2" style="font-family: Arial, sans-serif;"><div style="${sectionTitle}">DESGLOSE DETALLADO DE LA SIMULACIÓN (${offer.name})</div></td></tr>
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="margin-top: 10px; margin-bottom: 20px; border-collapse: collapse;" role="presentation">
                            <tr><td colspan="2" style="font-family: Arial, sans-serif;"><div style="font-weight: bold; color: ${BLUE_MED}; padding: 5px 0 2px 0;">TÉRMINO POTENCIA (Precio en €/kW Día)</div></td></tr>
                            <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">P1 (${num(bd.potencia_p1_kw,2)} kW x ${bd.dias_facturados}d x ${numPriceFormula(bd.priceP1Day)})</td><td style="${rowValue} font-family: monospace; font-size: 12px;">${num(bd.costP1, 2)} €</td></tr>
                            <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">P2 (${num(bd.potencia_p2_kw,2)} kW x ${bd.dias_facturados}d x ${numPriceFormula(bd.priceP2Day)})</td><td style="${rowValue} font-family: monospace; font-size: 12px;">${num(bd.costP2, 2)} €</td></tr>
                            
                            <!-- TÉRMINO ENERGÍA -->
                            <tr><td colspan="2" style="font-family: Arial, sans-serif;"><div style="font-weight: bold; color: ${BLUE_MED}; padding: 5px 0 2px 0;">TÉRMINO ENERGÍA (Precios en €/kWh)</div></td></tr>
                            <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">E1 (${num(bd.consumo_punta,0)} kWh x ${numPriceFormula(offer.p1_price)})</td><td style="${rowValue} font-family: monospace; font-size: 12px;">${num(bd.costE1, 2)} €</td></tr>
                            <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">E2 (${num(bd.consumo_llano,0)} kWh x ${numPriceFormula(offer.p2_price)})</td><td style="${rowValue} font-family: monospace; font-size: 12px;">${num(bd.costE2, 2)} €</td></tr>
                            <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">E3 (${num(bd.consumo_valle,0)} kWh x ${numPriceFormula(offer.p3_price)})</td><td style="${rowValue} font-family: monospace; font-size: 12px;">${num(bd.costE3, 2)} €</td></tr>
                            
                            <!-- SUBTOTALES E IMPUESTOS -->
                            <tr><td style="${rowLabel} border-top: 2px solid #333333; font-weight: bold; color: ${BLUE_DARK}; font-family: Arial, sans-serif;">SUBTOTAL (P+E)</td><td style="${rowValue} border-top: 2px solid #333333; font-weight: bold; color: ${BLUE_DARK}; font-family: Arial, sans-serif;">${num(bd.subBase, 2)} €</td></tr>
                            <tr><td style="${rowLabel} font-family: Arial, sans-serif;">Impuesto Eléc. (${num(bd.IE_RATE * 100, 3)}%)</td><td style="${rowValue} font-family: Arial, sans-serif;">${num(bd.costIE, 2)} €</td></tr>
                            <tr><td style="${rowLabel} font-weight: bold; font-family: Arial, sans-serif;">BASE IMPONIBLE</td><td style="${rowValue} font-weight: bold; font-family: Arial, sans-serif;">${num(bd.baseImp, 2)} €</td></tr>
                            <tr><td style="${rowLabel} font-family: Arial, sans-serif;">IVA (21%)</td><td style="${rowValue} font-family: Arial, sans-serif;">${num(bd.costIVA, 2)} €</td></tr>
                            
                            <!-- TOTALES FINALES (TOTAL MES Y TOTAL AÑO) -->
                            <tr><td style="${rowLabel} background-color: #eeeeee; font-weight: bold; font-family: Arial, sans-serif;">TOTAL PERIODO FACTURADO (${bd.dias_facturados} DÍAS)</td><td style="${rowValue} background-color: #eeeeee; font-size: 16px; font-family: Arial, sans-serif;">${eur(bd.totalPeriod)}</td></tr>
                             <!-- LÍNEA DE TOTAL AÑO -->
                            <tr><td style="${rowLabel} background-color: #eeeeee; font-weight: bold; font-family: Arial, sans-serif;">TOTAL AÑO (PROYECTADO)</td><td style="${rowValue} background-color: #eeeeee; font-size: 16px; font-family: Arial, sans-serif;">${eur(bd.totalAnnual)}</td></tr>
                        </table>
                    </td></tr>
                    
                    <!-- 5. NUEVO RESUMEN DE AHORRO AL FINAL -->
                    <tr><td colspan="2" style="padding: 0 20px 0 20px; text-align: center; font-family: Arial, sans-serif;">
                        <div style="text-align: center; margin: 15px 0 5px 0;">
                            <p style="margin: 0; font-size: 16px; color: ${BLUE_DARK}; font-weight: bold; font-family: Arial, sans-serif;">RESUMEN DE AHORRO FINAL</p>
                        </div>
                        <div style="background-color: ${BG_LIGHT}; padding: 15px; border-radius: 8px; border: 1px solid #dddddd; margin-bottom: 20px;">
                            <p style="margin: 0; font-size: 14px; color: ${GRAY_TEXT}; font-family: Arial, sans-serif;">TU AHORRO ANUAL ESTIMADO ES:</p>
                            <span style="font-size: 32px; font-weight: bold; color: ${BLUE_CTA}; display: block; margin-top: 5px; font-family: Arial, sans-serif;">${eur(bd.savings)}</span>
                        </div>
                    </td></tr>

                    <!-- CTA BOTÓN VML/HTML -->
                    <tr><td colspan="2" align="center" style="text-align: center; padding: 0 20px 20px 20px;">
                        ${CTA_SECTION}
                        <p style="font-size: 10px; color: #999; margin-top: 10px; font-family: Arial, sans-serif;">[Colaborador: ${commercialCode}] | Este resumen es una simulación basada en su última factura.</p>
                    </td></tr>

                    <!-- PIE DE PÁGINA BONITO -->
                    <tr><td colspan="2" style="padding: 0; height: 10px;"><div style="${footerStyle} border-radius: 0 0 8px 8px;"></div></td></tr>
                </table>
            `;

            // Envolver la tabla principal en un documento HTML completo para una copia/pegada más robusta en clientes de correo
            return `
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Oferta DRK Energía</title>
    <!-- [if gte mso 9]><xml>
    <o:OfficeDocumentSettings><o:AllowPNG/><o:PixelsPerInch>96</o:PixelsPerInch></o:OfficeDocumentSettings>
    </xml><![endif]-->
</head>
<body style="margin: 0; padding: 0; background-color: #f8fafc;">
    <center style="width: 100%; background-color: #f8fafc;">
        <!-- [if mso | IE]>
        <table align="center" border="0" cellpadding="0" cellspacing="0" width="600" style="width:600px; margin: 0 auto; mso-table-lspace: 0pt !important; mso-table-rspace: 0pt !important;" role="presentation">
        <tr>
        <td style="line-height:0; font-size:0; mso-line-height-rule:exactly;">
        <![endif]-->
        ${mainTableContent}
        <!-- [if mso | IE]>
        </td>
        </tr>
        </table>
        <![endif]-->
    </center>
</body>
</html>
            `;
        }


        function showView(viewId) {
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('results-view').classList.add('hidden');
            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('results-view').classList.remove('animate-fade-in-up'); 
            const target = document.getElementById(viewId);
            target.classList.remove('hidden');
            if(viewId === 'results-view') target.classList.add('animate-fade-in-up');
        }
        
        // --- Modals (Global Functions) ---
        window.showErrorModal = (msg) => {
            document.getElementById('error-title').textContent = "¡Atención!";
            document.getElementById('error-icon').className = "w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4";
            document.getElementById('error-icon').innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            document.getElementById('error-message').textContent = msg;
            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
        }
        window.showMessageModal = (msg) => {
             document.getElementById('error-title').textContent = "Éxito";
             document.getElementById('error-icon').className = "w-12 h-12 bg-drk-100 text-drk-500 rounded-full flex items-center justify-center mx-auto mb-4";
             document.getElementById('error-icon').innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
             document.getElementById('error-message').textContent = msg;
             document.getElementById('error-modal').classList.remove('hidden');
             document.getElementById('error-modal').classList.add('flex');
        }
        window.hideErrorModal = () => {
            document.getElementById('error-modal').classList.add('hidden');
            document.getElementById('error-modal').classList.remove('flex');
        }
        window.resetApp = () => {
            stopScanner();
            lastComparisonResult = null;
            showView('initial-view');
            els.loadingStatus.classList.add('hidden');
            els.startScanBtn.disabled = false;
            els.uploadMenuBtn.disabled = false; 
        };
        
        // --- Scanner Logic ---
        function startScanner() {
            if (currentTariffs.length === 0) return window.showErrorModal("Cargando tarifas, espere...");
            if (scannerRunning) return;
            showView('scanner-view');
            scannerRunning = true;
            
            // Create video/canvas elements inside the interactive viewport
            video = document.createElement('video');
            video.autoplay = true;
            video.playsInline = true;
            video.style.maxWidth = '100%';
            video.style.height = '100%';
            video.style.objectFit = 'cover';

            canvas = document.createElement('canvas');
            canvasCtx = canvas.getContext('2d');
            
            els.interactiveViewport.innerHTML = '';
            els.interactiveViewport.appendChild(video);
            
            // Request camera access
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
                stream = s; 
                video.srcObject = stream;
                video.onloadedmetadata = () => { 
                    video.play(); 
                    scanLoop(); 
                };
            }).catch(err => {
                console.error("Camera access error:", err); 
                stopScanner();
                window.showErrorModal("Error al acceder a la cámara. Asegúrese de tener permisos o use la opción de subir imagen.");
                window.resetApp();
            });
        }
        
        function scanLoop() {
            if (!scannerRunning || !video || video.readyState !== video.HAVE_ENOUGH_DATA) { 
                animationFrameId = requestAnimationFrame(scanLoop); 
                return; 
            }
            if (canvas.width !== video.videoWidth) { 
                canvas.width = video.videoWidth; 
                canvas.height = video.videoHeight; 
            }
            
            // Draw image to canvas
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Get image data and scan for QR code
            const imageData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code) { 
                handleQRRead(code.data); 
            } else { 
                animationFrameId = requestAnimationFrame(scanLoop); 
            }
        }
        
        function stopScanner() {
            scannerRunning = false;
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (stream) stream.getTracks().forEach(t => t.stop());
            video = null;
            // Optionally clear the viewport content
            if (els.interactiveViewport) els.interactiveViewport.innerHTML = ''; 
        }
        
        function capturePhoto() {
            if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) return window.showErrorModal("La cámara no está lista.");
            
            // Re-use canvas from scanning loop or create a temporary one if needed
            if (!canvas || !canvasCtx) {
                canvas = document.createElement('canvas');
                canvasCtx = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }
            
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code) { 
                stopScanner(); 
                handleQRRead(code.data); 
            } 
            else { 
                window.showErrorModal("No se detectó ningún QR en la foto capturada."); 
            }
        }
        
        function setupPasteCatcher() {
            // Global paste listener checks if the modal is open AND the paste catcher is focused
            document.addEventListener('paste', (e) => {
                const modalVisible = !document.getElementById('qr-options-modal').classList.contains('hidden');
                // Check if the paste catcher element is the active/focused element
                const pasteCatcherFocused = document.getElementById('paste-catcher') === document.activeElement; 
                
                if (!modalVisible || !pasteCatcherFocused) return;

                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const blob = items[i].getAsFile();
                        if (blob) {
                            document.getElementById('qr-options-modal').classList.add('hidden');
                            document.getElementById('qr-options-modal').classList.remove('flex');
                            e.preventDefault(); // Prevent default text paste
                            processImageForQR(blob);
                            break;
                        }
                    }
                }
            });
            
            // Focus the invisible textarea when the button is clicked to enable paste listening
            document.getElementById('modal-paste-image-btn').addEventListener('click', () => {
                const pasteCatcher = document.getElementById('paste-catcher');
                pasteCatcher.focus();
                // Select the text area content to facilitate replacement
                pasteCatcher.select(); 
                window.showMessageModal("Presione CTRL+V (o Cmd+V) para pegar la imagen de la factura.");
                // Hide the success message after a few seconds
                setTimeout(window.hideErrorModal, 3000); 
            });
        }
        
        function processImageForQR(file) {
            els.loadingStatus.textContent = "Procesando imagen...";
            els.loadingStatus.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    let { width, height } = img;
                    
                    // Resize for performance on large images
                    const max_dim = 1500;
                    if (width > max_dim || height > max_dim) {
                        const ratio = Math.min(max_dim / width, max_dim / height);
                        width *= ratio; height *= ratio;
                    }
                    tempCanvas.width = width; tempCanvas.height = height;
                    tempCtx.drawImage(img, 0, 0, width, height);
                    
                    try {
                        const imageData = tempCtx.getImageData(0, 0, width, height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        
                        els.loadingStatus.classList.add('hidden');
                        
                        if (code) handleQRRead(code.data);
                        else window.showErrorModal("No se encontró QR en la imagen.");
                        
                    } catch (error) {
                        console.error(error); els.loadingStatus.classList.add('hidden');
                        window.showErrorModal("Error procesando la imagen.");
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // New function to handle mode changes and style the radio buttons
        function updateComparisonMode(newMode) {
            comparisonMode = newMode;
            document.querySelectorAll('.mode-selector').forEach(label => {
                const input = label.querySelector('input[name="comparison_mode"]');
                // Clean up all styles first
                label.classList.remove('border-drk-500', 'bg-drk-500', 'text-white', 'text-slate-600', 'bg-white', 'hover:bg-drk-600');
                label.classList.add('border-drk-300', 'bg-white', 'text-slate-600', 'hover:bg-drk-100'); // Set default inactive styles

                if (input.value === newMode) {
                    // Selected style
                    label.classList.remove('border-drk-300', 'bg-white', 'text-slate-600', 'hover:bg-drk-100'); // Remove inactive styles
                    label.classList.add('border-drk-500', 'bg-drk-500', 'text-white', 'hover:bg-drk-600');
                }
            });
        }

        // --- FUNCIÓN DE INICIALIZACIÓN ---
        function initApp() {
            // 1. Intentar cargar la última versión de Google Sheets
            fetchTariffsFromSheet();

            // 2. Listeners
            els.startScanBtn.addEventListener('click', startScanner);
            els.stopScanBtn.addEventListener('click', stopScanner);
            els.capturePhotoBtn.addEventListener('click', capturePhoto);
            
            // Listener para mostrar el modal de OFERTA (modal de datos del comercial/cliente)
            els.sendOfferBtn.addEventListener('click', () => {
                if (lastComparisonResult) {
                    els.sendOfferModal.classList.remove('hidden');
                    els.sendOfferModal.classList.add('flex');
                } else {
                    window.showErrorModal("Por favor, analice una factura primero para generar una oferta.");
                }
            });
            
            // Listener unificado para COPIAR COMPARATIVO (HTML)
            els.executeSendOfferBtn.addEventListener('click', handleCopyOffer);


            // Listeners para el menú de opciones QR manual
            els.uploadMenuBtn.addEventListener('click', () => {
                els.qrOptionsModal.classList.remove('hidden');
                els.qrOptionsModal.classList.add('flex');
            });
            
            // Clic en "Subir Imagen" abre el input de archivo
            document.getElementById('modal-upload-file-btn').addEventListener('click', () => document.getElementById('image-file-input').click()); 
            
            // Procesar el archivo subido
            document.getElementById('image-file-input').addEventListener('change', (e) => {
                document.getElementById('qr-options-modal').classList.add('hidden');
                document.getElementById('qr-options-modal').classList.remove('flex');
                if (e.target.files[0]) processImageForQR(e.target.files[0]);
                // Clear the file input after processing so the change event fires again if the same file is selected
                e.target.value = ''; 
            });
            
            // Configurar el "pegado" de imagen
            setupPasteCatcher();
            
            // 3. Listeners for Comparison Mode
            document.querySelectorAll('input[name="comparison_mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    updateComparisonMode(e.target.value);
                });
                // Set initial state on load
                if (radio.checked) {
                    updateComparisonMode(radio.value);
                }
            });
            
            console.log("App iniciada. Cargando tarifas automáticamente...");
        }

        window.onload = initApp;

    </script>
</body>
</html>
